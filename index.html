<!doctype html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="description" content="Personal blog">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,index,follow">

  <title>PCTF 2017: YACP- br0ns</title>

  <link href="http://fonts.googleapis.com/css?family=Josefin+Sans" rel="stylesheet" type="text/css">
  <link href="http://fonts.googleapis.com/css?family=Oswald" rel="stylesheet" type="text/css">
  <link href="http://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet" type="text/css">
  <link href="http://fonts.googleapis.com/css?family=Crimson+Text" rel="stylesheet" type="text/css">
  <link href="http://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <link rel="stylesheet" href="./css/normalize.css">
  <link rel="stylesheet" href="./css/noise.css">
  <link rel="stylesheet" href="./css/style.css">

  <!-- This is needed because Chrome gets the x-height wrong for the "Crimson
    -- Text" font... no clue why
    -->
  <script type="text/javascript">
    window.MathJax = {
    "HTML-CSS": {minScaleAdjust: 100}
    };
  </script>

  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script type="text/javascript" src="./js/highslide.js"></script>
  <script type="text/javascript" src="./js/script.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  

</head>

<body>
  <div id="header-container">
<header>
  <div id="header">
    <div id="title">
      <a href="./posts/pctf17/yacp">
        PCTF 2017: YACP
      </a>
    </div>

    
    <div id="byline">
      Points: 300, Category: Pwnable
    </div>
    

    
    <div id="meta">
      <ul>
        <li>
          

            
          <i class="fa fa-calendar"></i>&nbsp;
          May  8, 2017
          
        </li>

        <li>
          <i class="fa fa-code-fork"></i>&nbsp;
          <a href="https://github.com/br0ns/blog/commit/2f85c7ce9be66ebec48fbce6e597ea3682774790" title="View on GitHub">
            2f85c7c&hellip;
          </a>
        </li>

        
        <li>
          <i class="fa fa-tags"></i>&nbsp;
          <a href="./tags/writeups">Writeups</a>
        </li>
        

      </ul>
    </div>
    

  </div>

  <div id="navbar-placeholder">

    <div id="navbar">
      <nav id="main-nav">
        <ul>
          <li>
            <a href="./">
              <i class="fa fa-lg fa-home"></i>
            </a>
          </li>

          <li>
            <a href="https://github.com/br0ns">
              <i class="fa fa-lg fa-github"></i>
            </a>
          </li>

          <li>
            <a href="./about">About</a>
          </li>

          <li>
            <a href="./tags/all">Archive</a>
          </li>

          <li>
            <a id="search-link">Search</a>
          </li>

        </ul>
      </nav>

      <div id="search-form-container">
        <form class="search" action="http://google.com/search" method="get">
          <input id="input" type="text" results="0" placeholder autocomplete="off" spellcheck="false">
        <input id="query" type="hidden" name="q" value>
        </form>
      </div>

    </div>

  </div>

</header>

  </div>

  <article id="content">
    <blockquote>
<p>What’s this? <a href="./posts/pctf17/yacp/yacp_13c264f8b1a8f3d0081086e6f12d7d05.tar.bz2">Yet another crypto problem</a>?</p>
<p>You’ve got to be kidding me!</p>
<p>Running at yacp.chal.pwning.xxx:7961</p>
</blockquote>
<p><strong>TL;DR</strong>: <a href="./posts/pctf17/yacp/doit.py" class="uri">doit.py</a></p>
<h1><span class="left-of"><span class="link-icon"><i class="fa fa-link"></i></span><span class="section-number"></span></span><span class="anchor" id="introduction"></span><a href="./posts/pctf17/yacp/#introduction">Introduction</a></h1>
<p>We are given an archive containing three files:</p>
<ul>
<li><code>yacp</code></li>
<li><code>libc​.so​.6</code></li>
<li><code>libcrypto​.so​.1​.0​.0</code></li>
</ul>
<p>The first is a 32 bit ELF binary and the latter two are presumably versions of libraries running on the remote server.</p>
<p>First, the program requires a proof of work. We are given a 16 byte prefix which is the hex-encoding of 8 random bytes read from <code>/dev​/urandom</code>. The goal is then to find a 32 byte string starting with that prefix whose SHA-256 sum’s 28 upper bits are 1.</p>
<p>This check can however be disabled by giving the program any number of command line arguments. This is very convenient during exploit development.</p>
<p>The actual program is some sort of “crypto service”. We are presented with a main menu where we can choose to:</p>
<ul>
<li>Load data</li>
<li>Generate random data</li>
<li>Hash data</li>
<li>Encrypt data</li>
<li>Decrypt data</li>
<li>Display data</li>
</ul>
<p>Data is kept in 32 buffers each 2048 bytes which are statically allocated in the data segment. The datum sizes are 4 byte unsigned integers and are also stored in the data segment, right after the buffers.</p>
<p>For hashing and encryption/decryption <a href="https://wiki.openssl.org/index.php/EVP">OpenSSL EVP</a> is used. Pointers to the EVP digest/cipher being used and corresponding digest/cipher contexts are stored after the buffer sizes.</p>
<p>The (relevant part of) data segment is laid out like this:<br />
   <code>0x0804c0e0</code>: Buffer #0<br />
   …<br />
   <code>0x0805b8e0</code>: Buffer #31<br />
   <code>0x0805c0e0</code>: Size of datum #0<br />
   …<br />
   <code>0x0805c15c</code>: Size of datum #31<br />
   <code>0x0805c160</code>: OpenSSL EVP digest object (24 bytes)<br />
   <code>0x0805c178</code>: OpenSSL EVP cipher object (140 bytes)<br />
   <code>0x0805c204</code>: Pointer to EVP digest<br />
   <code>0x0805c208</code>: Pointer to EVP cipher</p>
<h1><span class="left-of"><span class="link-icon"><i class="fa fa-link"></i></span><span class="section-number"></span></span><span class="anchor" id="vulnerabilities"></span><a href="./posts/pctf17/yacp/#vulnerabilities">Vulnerabilities</a></h1>
<p>I spotted two mistakes in the program:</p>
<ul>
<li><p>The largest message that can be encrypted is a full buffer. But because of plaintext padding the resulting ciphertext may be larger than a full buffer.</p></li>
<li><p>If an unknown digest/cipher algorithm is selected an error message is printed but the program does not actually exit. The currently selected digest/cipher will continue to be used.</p></li>
</ul>
<p>For the first error consider this diagram which shows encrypting a full buffer with AES-256 in <a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Cipher_Block_Chaining_.28CBC.29">CBC mode</a>.</p>
<figure>
<img src="./posts/pctf17/yacp/encrypt.svg" />
</figure>
<p>Since a block of padding is added to the message we have a one block overflow past the end of the ciphertext buffer. If the ciphertext is placed in buffer #31 this overflow will overwrite the first four datum sizes.</p>
<p>The second error can be relevant depending on the exact exploit you decide to implement. In the exploit I’ll describe below it will not be relevant. Exercise to the reader: what exploit, then, will rely on this error?</p>
<h1><span class="left-of"><span class="link-icon"><i class="fa fa-link"></i></span><span class="section-number"></span></span><span class="anchor" id="information-leak"></span><a href="./posts/pctf17/yacp/#information-leak">Information leak</a></h1>
<p>By overwriting the size of datum #0 and then display it we can leak the data segment. But we need to be able to control the size, not just overwrite it. Consider the diagram above again. For convenience we define <span class="math inline">\(x_n = c_{n-1} \oplus p_0\)</span>.</p>
<p>Then we have</p>
<p><span class="math display">\[
    \begin{align}
    size_{0-3} &amp; = c_{128} \\
               &amp; = E(x_{128}) \\
               &amp; = E(\texttt{&quot;\x10}\ldots\texttt{&quot;} \oplus c_{127}) \\
               &amp; = E(\texttt{&quot;\x10}\ldots\texttt{&quot;} \oplus E(x_{127})) \\
               &amp; = E(\texttt{&quot;\x10}\ldots\texttt{&quot;} \oplus E(p_{127} \oplus
                   c_{126}))
    \end{align}
\]</span></p>
<p>Solving for <span class="math inline">\(size_{0-3}\)</span> we get</p>
<p><span class="math display">\[
    \begin{align}
    size_{0-3} &amp; =
      E(\texttt{&quot;\x10}\ldots\texttt{&quot;} \oplus E(p_{127} \oplus c_{126})) \\
    D(size_{0-3}) &amp; =
      \texttt{&quot;\x10}\ldots\texttt{&quot;} \oplus E(p_{127} \oplus c_{126}) \\
    \texttt{&quot;\x10}\ldots\texttt{&quot;} \oplus D(size_{0-3}) &amp; =
      E(p_{127} \oplus c_{126}) \\
    D(\texttt{&quot;\x10}\ldots\texttt{&quot;} \oplus D(size_{0-3})) &amp; =
      p_{127} \oplus c_{126} \\
    c_{126} \oplus D(\texttt{&quot;\x10}\ldots\texttt{&quot;} \oplus D(size_{0-3})) &amp; =
      p_{127} \\
    \end{align}
\]</span></p>
<p>OK, so to compute plaintext which will let us control <span class="math inline">\(size_{0-3}\)</span> we first encrypt 127 arbitrary data blocks (<span class="math inline">\(p_0 \ldots p_{126}\)</span>) with an arbitrary key and IV, then derive the last plaintext block per the equations above.</p>
<h1><span class="left-of"><span class="link-icon"><i class="fa fa-link"></i></span><span class="section-number"></span></span><span class="anchor" id="memory-write"></span><a href="./posts/pctf17/yacp/#memory-write">Memory write</a></h1>
<p>By setting the size of datum #0 and encrypting/decrypting it into buffer #31 we can overflow arbitrarily far into the data segment. The part that will overflow past buffer #31 should be placed in buffer #1, which is convenient since that will not change the size of datum #0. One (and the easiest, IMO) way to carry out this attack is to place the encrypted overflow in buffer #1, then decrypt datum #0 (with its size set appropriately) into buffer #31. This diagram should make it clear:</p>
<figure>
<img src="./posts/pctf17/yacp/decrypt.svg" />
</figure>
<p>Another thing to note is that the plaintext doesn’t need to have the correct padding because the decryption function never checks the return value of <code>EVP_DecryptFinal_ex</code>.</p>
<p>From the diagram it is clear that the “IV” for the ciphertext in buffer #1 is the last block in buffer #0. And if we never actually write anything to buffer #0 then it will be all zeros.</p>
<h1><span class="left-of"><span class="link-icon"><i class="fa fa-link"></i></span><span class="section-number"></span></span><span class="anchor" id="exploit"></span><a href="./posts/pctf17/yacp/#exploit">Exploit</a></h1>
<p><strong>Note</strong>: There are many ways to exploit this service given the vulnerabilities outlined above. The one I’ll go through here is actually not the one I wrote during the CTF (this one’s prettier). During the CTF I used sizes of “big enough” and weeded out segfaults using a combination of GDB (<a href="http://docs.pwntools.com/en/stable/gdb.html?highlight=gdb#pwnlib.gdb.attach"><code>gdb​.attach</code></a>) and <a href="http://docs.pwntools.com/en/stable/util/cyclic.html?highlight=cyclic#pwnlib.util.cyclic.cyclic"><code>cyclic</code></a> until I had a working exploit.</p>
<p>On to the exploit. So we can read and write memory in the data segment. What can we do with that?</p>
<p>We can overwrite the digest/cipher contexts and pointers. Lets have a look at the <a href="https://github.com/openssl/openssl">OpenSSL source code</a>. At the time of this writing the latest commit was <a href="https://github.com/openssl/openssl/tree/d396da33130aba2e77478d00fd369eb8d34bd8bf">d396da</a>, so the code below is taken from that commit.</p>
<p>The definition of a cipher context is given in <a href="https://github.com/openssl/openssl/blob/d396da33130aba2e77478d00fd369eb8d34bd8bf/crypto/evp/evp_locl.h"><code>crypto​/evp​/evp_locl​.h</code></a>:</p>
<div class="codeblock-container"><figure class="codeblock c"><div class="buttons-container"><a href="./posts/pctf17/yacp/snippet0.c" class="download-link" title="Download snippet"><i class="fa fa-download"></i></a></div><div class="highlight"><pre><span></span><span id="line-24"><span class="lineno">24 </span><span class="k">struct</span> <span class="n">evp_cipher_ctx_st</span> <span class="p">{</span>
</span><span id="line-25"><span class="lineno">25 </span>    <span class="k">const</span> <span class="n">EVP_CIPHER</span> <span class="o">*</span><span class="n">cipher</span><span class="p">;</span>
</span><span id="line-26"><span class="lineno">26 </span>    <span class="n">ENGINE</span> <span class="o">*</span><span class="n">engine</span><span class="p">;</span>             <span class="cm">/* functional reference if 'cipher' is</span>
</span><span id="line-27"><span class="lineno">27 </span><span class="cm">                                 * ENGINE-provided */</span>
</span><span id="line-28"><span class="lineno">28 </span>    <span class="kt">int</span> <span class="n">encrypt</span><span class="p">;</span>                <span class="cm">/* encrypt or decrypt */</span>
</span><span id="line-29"><span class="lineno">29 </span>    <span class="kt">int</span> <span class="n">buf_len</span><span class="p">;</span>                <span class="cm">/* number we have left */</span>
</span><span id="line-30"><span class="lineno">30 </span>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">oiv</span><span class="p">[</span><span class="n">EVP_MAX_IV_LENGTH</span><span class="p">];</span> <span class="cm">/* original iv */</span>
</span><span id="line-31"><span class="lineno">31 </span>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">iv</span><span class="p">[</span><span class="n">EVP_MAX_IV_LENGTH</span><span class="p">];</span> <span class="cm">/* working iv */</span>
</span><span id="line-32"><span class="lineno">32 </span>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">EVP_MAX_BLOCK_LENGTH</span><span class="p">];</span> <span class="cm">/* saved partial block */</span>
</span><span id="line-33"><span class="lineno">33 </span>    <span class="kt">int</span> <span class="n">num</span><span class="p">;</span>                    <span class="cm">/* used by cfb/ofb/ctr mode */</span>
</span><span id="line-34"><span class="lineno">34 </span>    <span class="cm">/* FIXME: Should this even exist? It appears unused */</span>
</span><span id="line-35"><span class="lineno">35 </span>    <span class="kt">void</span> <span class="o">*</span><span class="n">app_data</span><span class="p">;</span>             <span class="cm">/* application stuff */</span>
</span><span id="line-36"><span class="lineno">36 </span>    <span class="kt">int</span> <span class="n">key_len</span><span class="p">;</span>                <span class="cm">/* May change for variable length cipher */</span>
</span><span id="line-37"><span class="lineno">37 </span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>        <span class="cm">/* Various flags */</span>
</span><span id="line-38"><span class="lineno">38 </span>    <span class="kt">void</span> <span class="o">*</span><span class="n">cipher_data</span><span class="p">;</span>          <span class="cm">/* per EVP data */</span>
</span><span id="line-39"><span class="lineno">39 </span>    <span class="kt">int</span> <span class="n">final_used</span><span class="p">;</span>
</span><span id="line-40"><span class="lineno">40 </span>    <span class="kt">int</span> <span class="n">block_mask</span><span class="p">;</span>
</span><span id="line-41"><span class="lineno">41 </span>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">final</span><span class="p">[</span><span class="n">EVP_MAX_BLOCK_LENGTH</span><span class="p">];</span> <span class="cm">/* possible final block */</span>
</span><span id="line-42"><span class="lineno">42 </span><span class="p">}</span> <span class="cm">/* EVP_CIPHER_CTX */</span> <span class="p">;</span>
</span></pre></div>
</figure></div>
<p>And the definition of a cipher is given in <a href="https://github.com/openssl/openssl/blob/d396da33130aba2e77478d00fd369eb8d34bd8bf/crypto/include/internal/evp_int.h"><code>crypto​/include​/internal​/evp_int​.h</code></a>:</p>
<div class="codeblock-container"><figure class="codeblock c"><div class="buttons-container"><a href="./posts/pctf17/yacp/snippet1.c" class="download-link" title="Download snippet"><i class="fa fa-download"></i></a></div><div class="highlight"><pre><span></span><span id="line-109"><span class="lineno">109 </span><span class="k">struct</span> <span class="n">evp_cipher_st</span> <span class="p">{</span>
</span><span id="line-110"><span class="lineno">110 </span>    <span class="kt">int</span> <span class="n">nid</span><span class="p">;</span>
</span><span id="line-111"><span class="lineno">111 </span>    <span class="kt">int</span> <span class="n">block_size</span><span class="p">;</span>
</span><span id="line-112"><span class="lineno">112 </span>    <span class="cm">/* Default value for variable length ciphers */</span>
</span><span id="line-113"><span class="lineno">113 </span>    <span class="kt">int</span> <span class="n">key_len</span><span class="p">;</span>
</span><span id="line-114"><span class="lineno">114 </span>    <span class="kt">int</span> <span class="n">iv_len</span><span class="p">;</span>
</span><span id="line-115"><span class="lineno">115 </span>    <span class="cm">/* Various flags */</span>
</span><span id="line-116"><span class="lineno">116 </span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
</span><span id="line-117"><span class="lineno">117 </span>    <span class="cm">/* init key */</span>
</span><span id="line-118"><span class="lineno">118 </span>    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)</span> <span class="p">(</span><span class="n">EVP_CIPHER_CTX</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
</span><span id="line-119"><span class="lineno">119 </span>                 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">iv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enc</span><span class="p">);</span>
</span><span id="line-120"><span class="lineno">120 </span>    <span class="cm">/* encrypt/decrypt data */</span>
</span><span id="line-121"><span class="lineno">121 </span>    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">do_cipher</span><span class="p">)</span> <span class="p">(</span><span class="n">EVP_CIPHER_CTX</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span>
</span><span id="line-122"><span class="lineno">122 </span>                      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">inl</span><span class="p">);</span>
</span><span id="line-123"><span class="lineno">123 </span>    <span class="cm">/* cleanup ctx */</span>
</span><span id="line-124"><span class="lineno">124 </span>    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cleanup</span><span class="p">)</span> <span class="p">(</span><span class="n">EVP_CIPHER_CTX</span> <span class="o">*</span><span class="p">);</span>
</span><span id="line-125"><span class="lineno">125 </span>    <span class="cm">/* how big ctx-&gt;cipher_data needs to be */</span>
</span><span id="line-126"><span class="lineno">126 </span>    <span class="kt">int</span> <span class="n">ctx_size</span><span class="p">;</span>
</span><span id="line-127"><span class="lineno">127 </span>    <span class="cm">/* Populate a ASN1_TYPE with parameters */</span>
</span><span id="line-128"><span class="lineno">128 </span>    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_asn1_parameters</span><span class="p">)</span> <span class="p">(</span><span class="n">EVP_CIPHER_CTX</span> <span class="o">*</span><span class="p">,</span> <span class="n">ASN1_TYPE</span> <span class="o">*</span><span class="p">);</span>
</span><span id="line-129"><span class="lineno">129 </span>    <span class="cm">/* Get parameters from a ASN1_TYPE */</span>
</span><span id="line-130"><span class="lineno">130 </span>    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_asn1_parameters</span><span class="p">)</span> <span class="p">(</span><span class="n">EVP_CIPHER_CTX</span> <span class="o">*</span><span class="p">,</span> <span class="n">ASN1_TYPE</span> <span class="o">*</span><span class="p">);</span>
</span><span id="line-131"><span class="lineno">131 </span>    <span class="cm">/* Miscellaneous operations */</span>
</span><span id="line-132"><span class="lineno">132 </span>    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ctrl</span><span class="p">)</span> <span class="p">(</span><span class="n">EVP_CIPHER_CTX</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
</span><span id="line-133"><span class="lineno">133 </span>    <span class="cm">/* Application data */</span>
</span><span id="line-134"><span class="lineno">134 </span>    <span class="kt">void</span> <span class="o">*</span><span class="n">app_data</span><span class="p">;</span>
</span><span id="line-135"><span class="lineno">135 </span><span class="p">}</span> <span class="cm">/* EVP_CIPHER */</span> <span class="p">;</span>
</span></pre></div>
</figure></div>
<p>See all those juicy pointers? We can overflow into the <code>cipher</code> field of the cipher context and point it to somewhere we control (say one of the buffers) and place a fake cipher there.</p>
<p>The program has this sequence of calls in its decryption function:</p>
<div class="codeblock-container"><figure class="codeblock c"><div class="buttons-container"><a href="./posts/pctf17/yacp/snippet2.c" class="download-link" title="Download snippet"><i class="fa fa-download"></i></a></div><div class="highlight"><pre><span></span><span id="line-1"><span class="lineno">1 </span><span class="n">EVP_CIPHER_CTX_init</span><span class="p">(</span><span class="n">cipher_ctx</span><span class="p">);</span>
</span><span id="line-2"><span class="lineno">2 </span><span class="n">EVP_CipherInit_ex</span><span class="p">(</span><span class="n">cipher_ctx</span><span class="p">,</span> <span class="n">cipher</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffers</span><span class="p">[</span><span class="mi">2048</span> <span class="o">*</span> <span class="n">key</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">buffers</span><span class="p">[</span><span class="mi">2048</span> <span class="o">*</span> <span class="n">iv</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
</span><span id="line-3"><span class="lineno">3 </span><span class="n">EVP_CipherUpdate</span><span class="p">(</span><span class="n">cipher_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffers</span><span class="p">[</span><span class="mi">2048</span> <span class="o">*</span> <span class="n">out</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">outl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffers</span><span class="p">[</span><span class="mi">2048</span> <span class="o">*</span> <span class="n">in</span><span class="p">],</span> <span class="n">sizes</span><span class="p">[</span><span class="n">in</span><span class="p">]);</span>
</span><span id="line-4"><span class="lineno">4 </span><span class="n">EVP_CipherFinal_ex</span><span class="p">(</span><span class="n">cipher_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffers</span><span class="p">[</span><span class="mi">2048</span> <span class="o">*</span> <span class="n">out</span> <span class="o">+</span> <span class="n">outl</span><span class="p">]</span> <span class="o">+</span> <span class="n">outl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">outl_final</span><span class="p">);</span>
</span><span id="line-5"><span class="lineno">5 </span><span class="n">EVP_CIPHER_CTX_cleanup</span><span class="p">(</span><span class="n">cipher_ctx</span><span class="p">);</span>
</span></pre></div>
</figure></div>
<p>The function <a href="https://github.com/openssl/openssl/blob/d396da33130aba2e77478d00fd369eb8d34bd8bf/crypto/evp/evp_enc.c#L207"><code>EVP_CipherUpdate</code></a> encrypts/decrypts a number of full blocks and saves any remaining data in an internal buffer. It will make the exploit easier if we overflow a number of full blocks. So keep that in mind when reading the final exploit.</p>
<p>When <a href="https://github.com/openssl/openssl/blob/d396da33130aba2e77478d00fd369eb8d34bd8bf/crypto/evp/evp_enc.c#L216"><code>EVP_CipherFinal</code></a> is called the overflow will have happened and (part of) <code>cipher_ctx</code> is controlled by us. So lets have a look at that function:</p>
<div class="codeblock-container"><figure class="codeblock c"><div class="buttons-container"><a href="./posts/pctf17/yacp/snippet3.c" class="download-link" title="Download snippet"><i class="fa fa-download"></i></a></div><div class="highlight"><pre><span></span><span id="line-224"><span class="lineno">224 </span><span class="kt">int</span> <span class="nf">EVP_CipherFinal_ex</span><span class="p">(</span><span class="n">EVP_CIPHER_CTX</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">outl</span><span class="p">)</span>
</span><span id="line-225"><span class="lineno">225 </span><span class="p">{</span>
</span><span id="line-226"><span class="lineno">226 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">encrypt</span><span class="p">)</span>
</span><span id="line-227"><span class="lineno">227 </span>        <span class="k">return</span> <span class="n">EVP_EncryptFinal_ex</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">outl</span><span class="p">);</span>
</span><span id="line-228"><span class="lineno">228 </span>    <span class="k">else</span>
</span><span id="line-229"><span class="lineno">229 </span>        <span class="k">return</span> <span class="n">EVP_DecryptFinal_ex</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">outl</span><span class="p">);</span>
</span><span id="line-230"><span class="lineno">230 </span><span class="p">}</span>
</span></pre></div>
</figure></div>
<p>For this exploit it doesn’t matter whether <a href="https://github.com/openssl/openssl/blob/d396da33130aba2e77478d00fd369eb8d34bd8bf/crypto/evp/evp_enc.c#L379"><code>EVP_EncryptFinal_ex</code></a> or <a href="https://github.com/openssl/openssl/blob/d396da33130aba2e77478d00fd369eb8d34bd8bf/crypto/evp/evp_enc.c#L497"><code>EVP_DecryptFinal_ex</code></a> is called, so let’s just pick <code>EVP_EncryptFinal_ex</code> as that will allow for a wider range of values in <code>ctx-&gt;encrypt</code> (<span class="math inline">\(2^{32} - 1\)</span> vs. 1):</p>
<div class="codeblock-container"><figure class="codeblock c"><div class="buttons-container"><a href="./posts/pctf17/yacp/snippet4.c" class="download-link" title="Download snippet"><i class="fa fa-download"></i></a></div><div class="highlight"><pre><span></span><span id="line-379"><span class="lineno">379 </span><span class="kt">int</span> <span class="nf">EVP_EncryptFinal_ex</span><span class="p">(</span><span class="n">EVP_CIPHER_CTX</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">outl</span><span class="p">)</span>
</span><span id="line-380"><span class="lineno">380 </span><span class="p">{</span>
</span><span id="line-381"><span class="lineno">381 </span>    <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
</span><span id="line-382"><span class="lineno">382 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">bl</span><span class="p">;</span>
</span><span id="line-383"><span class="lineno">383 </span>
</span><span id="line-384"><span class="lineno">384 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">EVP_CIPH_FLAG_CUSTOM_CIPHER</span><span class="p">)</span> <span class="p">{</span>
</span><span id="line-385"><span class="lineno">385 </span>        <span class="n">ret</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="o">-&gt;</span><span class="n">do_cipher</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span id="line-386"><span class="lineno">386 </span>        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="line-387"><span class="lineno">387 </span>            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span id="line-388"><span class="lineno">388 </span>        <span class="k">else</span>
</span><span id="line-389"><span class="lineno">389 </span>            <span class="o">*</span><span class="n">outl</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span><span id="line-390"><span class="lineno">390 </span>        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span id="line-391"><span class="lineno">391 </span>    <span class="p">}</span>
</span><span id="line-392"><span class="lineno">392 </span><span class="c1">// ...</span>
</span></pre></div>
</figure></div>
<p>If the condition in the <code>if</code>-statement is satisfied the <code>do_cipher</code> function pointer is called. Note that the cipher context is given as the first argument. If we set <code>do_cipher</code> to be the address of <code>system</code> then the context will be run as a shell command. The first four bytes are the address of the faked cipher. They will probably not be a valid command (or one that hangs anyway) so if we follow them with <code>&quot;;sh ​#&quot;</code> we should be able to get a shell.</p>
<p>The final challenge is figuring out the address of <code>system</code>. We can use the information leak described above to leak the address current cipher. Since we’re given the server’s versions of <code>libc​.so</code> and <code>libcrypto​.so</code> we can then calculate the address of <code>system</code>.</p>
<p>In the information leak we set the size of buffer #0. The size should be set to</p>
<p><span class="math display">\[
    \begin{align}
    32 \cdot 2048 &amp;+ \hspace{5em} \textrm{(buffers)} \\
    32 \cdot 4 &amp;+ \hspace{5em} \textrm{(sizes)} \\
    24 &amp;+ \hspace{5em} \textrm{(digest context)} \\
    140 &amp;+ \hspace{5em} \textrm{(cipher context)} \\
    4 &amp;+ \hspace{5em} \textrm{(digest pointer)} \\
    4 &amp;+ \hspace{5em} \textrm{(cipher pointer)} \\
    &amp;= 65836
    \end{align}
\]</span></p>
<h2><span class="left-of"><span class="link-icon"><i class="fa fa-link"></i></span><span class="section-number"></span></span><span class="anchor" id="proof-of-work"></span><a href="./posts/pctf17/yacp/#proof-of-work">Proof of work</a></h2>
<p>As mentioned <code>yacp</code> requires a proof of work, but this can be disabled. Of course I disabled the check when I was reversing and exploiting the program.</p>
<p>Unfortunately I then forgot about it and when time came to fire off the exploit against the real service I was in for an unpleasant reminder. It was 10 or 15 minutes till the end of the CTF and I failed to implement proof of work generation in that time.</p>
<p>Bitterness prompted me to write a more general proof of work generation tool, so I won’t end up in this situation again. You can find it on Github here: <a href="https://www.github.com/br0ns/pow">POW</a>.</p>

<br />

<center>
  (<a id="link-to-top" href="./posts/pctf17/yacp">To top</a>)
</center>

<br />

<h1 class="notoc">
  <span class="left-of">
    <span class="link-icon">
      <i class="fa fa-link"></i>
    </span>
    <span class="section-number">
    </span>
  </span>
  <span class="anchor" id="comments">
  </span>
  <a href="./posts/pctf17/yacp/#comments">
    Comments
  </a>
</h1>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'br0ns';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  </article>

  <!-- Google analytics -->
  <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-67455623-1', 'auto');
    ga('send', 'pageview');
  </script>

</body>

</html>
